#
# $FreeBSD: head/etc/pam.d/su 219663 2011-03-15 10:13:35Z des $
#
# PAM configuration for the "su" service
#
<%
        ad_enabled = ldap_enabled = nis_enabled = nt4_enabled = False

        try:
	    ad_enabled = middleware.call('datastore.query', 'directoryservice.ActiveDirectory')[0]['ad_enable']
        except:
            pass 
        try:
	    ldap_enabled  = middleware.call('datastore.query', 'directoryservice.LDAP')[0]['ldap_enable']
        except:
            pass 
        try:
	    nis_enabled = middleware.call('datastore.query', 'directoryservice.NIS')[0]['nis_enable']
        except:
            pass 
        try:
	    nt4_enabled = middleware.call('datastore.query', 'directoryservice.NT4')[0]['nt4_enable']
        except:
            pass 
%>

# auth
auth		sufficient	pam_rootok.so		no_warn
auth		sufficient	pam_self.so		no_warn
% if ad_enabled or nt4_enabled:
auth		sufficient	/usr/local/lib/pam_winbind.so silent try_first_pass krb5_auth krb5_ccache_type=FILE
% endif
% if ldap_enabled:
auth		sufficient	/usr/local/lib/pam_sss.so
% endif
#auth		sufficient	pam_krb5.so		no_warn try_first_pass
auth		requisite	pam_group.so		no_warn group=wheel root_only ruser
auth		include		system

# account
account		include		system

# session
session		required	pam_permit.so
% if ad_enabled or ldap_enabled or nis_enabled or nt4_enabled:
session		required	/usr/local/lib/pam_mkhomedir.so
% endif
